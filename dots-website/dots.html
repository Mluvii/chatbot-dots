<html>

<head>
    <script src="jpeg_camera/jpeg_camera_no_flash.js"></script>
    <script src="jpeg_camera/canvas-to-blob.js"></script>
</head>

<body>
    <div style="height:100%; width:100%; background:url(mluviiweb.PNG)"></div>
    <div id="camera" style="height:1px;width:1px"></div>
    <script>

        function setupFaceRecognition() {
            window.addEventListener('message', msg => {
                if (msg.data.type === 'identifyFace') {
                    attempts = 3;
                    tryIdentifyPerson()
                }

            });
        }

        function tryIdentifyPerson() {
            if (attempts-- > 0) {
                var snapshot = camera.capture({
                    shutter: false
                });
                callFaceApi(snapshot);
            }
            else {
                faceRecognitionFinished(null);
            }
        }

        function callFaceApi(snapshot) {
            throttle(() => {
                Log("Calling Face API");
                snapshot.upload({
                    api_url: "https://dotsfaceapi3.azurewebsites.net/api/RecognizeFace"
                }).done(function (response) {
                    handleResponse(response)
                    this.discard();
                }).fail(function (status_code, error_message, response) {
                    console.warn("DOTS: Upload failed with status " + status_code);
                });
            }, 6000)();
        }

        function handleResponse(response) {
            if (!response)
                return;
            var respJson = JSON.parse(response)
            if (respJson.hasOwnProperty("PersonId")) {
                Log("Recognized personId: " + respJson.PersonId);
                faceRecognitionFinished(respJson.PersonId);

            } else {
                Log("I don't see anyone familiar");
                tryIdentifyPerson();
            }
        }

        function faceRecognitionFinished(personId) {
            document.querySelector(".onopChatIframe").contentWindow.postMessage({
                type: 'identifyFaceResult',
                payload: { personId: personId }
            }, '*');
        }

        function throttle(func, wait) {
            return function (...args) {
                const context = this;
                if (!window.hasOwnProperty("throttleTimeout") || !throttleTimeout) {
                    func.apply(context, args)
                    throttleTimeout = setTimeout(() => {
                        throttleTimeout = null;
                    }
                        , wait);
                }
            }
        }

        function Log(message) {
            console.debug("DOTS: " + message);
        }
    </script>
    <script type="text/javascript"> 
        (function () {
            var scr = document.createElement('script'); scr.type = 'text/javascript'; scr.async = true; scr.charset = 'UTF-8';
            scr.src = 'https://appdev.mluvii.com/widget/OOWidget.js';
            scr.$owidgetOnLoad = function (owidget) {
                if (!owidget.isSupported) { return; }
                owidget.init(["295b1064cf5b4a5d9e05e7a74f86ae5e", "107"], 'MluviiChat');
                camera = new JpegCamera("#camera");
                camera.ready(() => {
                    setupFaceRecognition();
                });
                owidget.connectToServer();
            };
            var ffs = document.getElementsByTagName('script')[0]; ffs.parentNode.insertBefore(scr, ffs);
        })();
    </script>
</body>

</html>