<html>

<head>
    <script src="jpeg_camera/jpeg_camera_no_flash.js"></script>
    <script src="jpeg_camera/canvas-to-blob.js"></script>
</head>

<body>
    <div style="height:100%; width:100%; background:url(mluviiweb.PNG)"></div>
    <div id="camera" style="height:1px;width:1px"></div>
    <script>

        function setupFaceRecognition() {
            window.addEventListener('message', msg => {
                if (msg.data.type === 'identifyFace') {
                    attempts = 3;
                    tryIdentifyPerson()
                }

            });
        }

        function tryIdentifyPerson() {
            if (attempts-- > 0) {
                var snapshot = camera.capture({
                    shutter: false
                });
                callFaceApi(snapshot);
            }
            else {
                faceRecognitionFinished(null);
            }
        }

        function callFaceApi(snapshot) {
            Log("Calling Face API");
            snapshot.upload({
                api_url: "https://dotsfaceapi4.azurewebsites.net/api/RecognizeFace"
            }).done(function (response) {
                handleResponse(response)
                this.discard();
            }).fail(function (status_code, error_message, response) {
                console.warn("DOTS: Upload failed with status " + status_code);
            });
        }

        function handleResponse(response) {
            var respJson = !!response && JSON.parse(response)
            if (!!respJson && respJson.hasOwnProperty("PersonId")) {
                Log("Recognized personId: " + respJson.PersonId);
                faceRecognitionFinished(respJson.PersonId);

            } else {
                Log("I don't see anyone familiar");
                setTimeout(() => tryIdentifyPerson(), 1000);
            }
        }

        function faceRecognitionFinished(personId) {
            document.onopChatIframe.frames[0].postMessage({
                type: 'identifyFaceResult',
                payload: { personId: personId }
            }, '*');
        }

        function Log(message) {
            console.debug("DOTS: " + message);
        }
    </script>
    <script type="text/javascript"> 
        (function () {
            var scr = document.createElement('script'); scr.type = 'text/javascript'; scr.async = true; scr.charset = 'UTF-8';
            scr.src = 'https://appdev.mluvii.com/widget/OOWidget.js';
            scr.$owidgetOnLoad = function (owidget) {
                if (!owidget.isSupported) { return; }
                owidget.init(["295b1064cf5b4a5d9e05e7a74f86ae5e", "107"], 'MluviiChat');
                camera = new JpegCamera("#camera");
                camera.ready(() => {
                    setupFaceRecognition();
                });
                owidget.connectToServer();
            };
            var ffs = document.getElementsByTagName('script')[0]; ffs.parentNode.insertBefore(scr, ffs);
        })();
    </script>
</body>

</html>